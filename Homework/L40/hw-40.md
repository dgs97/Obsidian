# Домашнее задание №40

## Цель
Ознакомиться с продвинутыми концепциями и практиками в инфраструктуре как коде с использованием Terraform. Получить практические навыки работы с зависимостями, управлением стейтом, модулями и удаленным хранением стейта в Terraform.

---
## Задание

#### 1. Создание модуля в Terraform
Создать модуль, который предоставляет повторно используемую функциональность для создания конкретного типа инфраструктуры (например, модуль для создания виртуальной машины с определенными параметрами).
#### 2. Использование созданного модуля
Использовать созданный модуль в основной конфигурации для развертывания инфраструктуры.
#### 3. Настройка удаленного хранения tfstate

Настроить отказоустойчивое и безопасное удаленное хранение состояния Terraform (tfstate) в Google Cloud Platform с использованием Cloud Storage и механизма блокировок состояния.
#### 4. Перенос существующей инфраструктуры
Перенести существующую инфраструктуру на удаленное хранение стейта.
#### 5. Дополнительное задание
Создать конфигурацию Terraform, в которой используется "depends_on" для определения зависимостей между ресурсами. Убедиться, что ресурсы создаются или обновляются в правильном порядке, используя это ключевое слово.

---
#### 1. Создаем структуру для Terraform:

![](screenshots/Pasted%20image%2020250819201514.png)

#### 2. Создание модуля в Terraform:

- `modules/vm_instance/main.tf`
- `modules/vm_instance/outputs.tf`
- `modules/vm_instance/variables.tf`

#### 3. Использование созданного модуля:

`environments/prod/*`

#### 4. Настройка удаленного хранения tfstate

`environments/prod/backend.tf`: 

```bash
terraform {
  backend "gcs" {
    bucket = "terraform-state-prod-bucket-12345" # Уникальное имя
    prefix = "terraform/state"
  }
}
```
#### 5. Подготовка инфраструктуры для state

 - Создаем бакет для Terraform state:
 
```bash
gsutil mb -p hw-40-469515 -l EUROPE-WEST3 gs://terraform-state-prod-bucket-12345/
```

![](screenshots/Pasted%20image%2020250819202028.png)

- Включаем versioning для бакета:

```bash
gsutil versioning set on gs://terraform-state-prod-bucket-12345/
```

![](screenshots/Pasted%20image%2020250819202237.png)
#### 6. Перенос существующей инфраструктуры (существующей нет)

```bash
cd environments/prod

# Инициализируем с новым backend
terraform init -reconfigure \
  -backend-config="bucket=terraform-state-prod-bucket-12345" \
  -backend-config="prefix=terraform/state"

# Переносим state в удаленное хранилище
terraform init -migrate-state
```

![](screenshots/Pasted%20image%2020250820195434.png)

![](screenshots/Pasted%20image%2020250820195527.png)

![](screenshots/Pasted%20image%2020250820203135.png)

#### 7. Дополнительное задание(depends_on):

`environments/prod/main.tf` содержит `depends_on`

```bash
# Инициализация
terraform init

# План
terraform plan

# Применение
terraform apply
```

![](screenshots/Pasted%20image%2020250820191502.png)

![](screenshots/Pasted%20image%2020250820195148.png)

![](screenshots/Pasted%20image%2020250821103727.png)

- Проверка блокировки:

```bash
# Попробуйте запустить в двух терминалах:
terraform apply
# Во втором терминале получите ошибку блокировки
```

![](screenshots/Pasted%20image%2020250821110938.png)

![](screenshots/Pasted%20image%2020250821111001.png)
