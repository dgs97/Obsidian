
## Домашнее задание №36: Высокая доступность и масштабируемость в Google Cloud Platform

**Цель:** Ознакомление с основными сервисами Google Cloud Platform, такими как **Cloud Load Balancing**, **Managed Instance Groups (MIGs)** и **Cloud DNS**. Задание поможет понять, как настроить и использовать сервисы GCP для обеспечения высокой доступности и масштабируемости приложения. Также задание предоставит практические навыки использования **gcloud CLI** для автоматизации настройки DNS-записей и маршрутизации трафика в Cloud DNS.

---

### Задание:

1. **Создайте Load Balancer в Google Cloud Platform с использованием `gcloud CLI`.**
    
2. **Настройте маршрутизацию трафика для вашего приложения с использованием Cloud Load Balancing и Managed Instance Groups.**
    
3. **Используя Cloud DNS, зарегистрируйте доменное имя для вашего приложения и настройте DNS-записи для обеспечения его доступности в Интернете.**
    
4. **Изучите документацию GCP по настройке маршрутизации трафика в Cloud DNS и настройте различные типы маршрутизации, такие как взвешенная маршрутизация (Weighted Round Robin) и маршрутизация на основе геоположения (Geo-location routing).**
    
5. **Используйте `gcloud CLI` для автоматизации настройки DNS-записей и маршрутизации трафика в Cloud DNS.**
    
6. **Изучите механизмы безопасности DNS в Cloud DNS и настройте SSL/TLS-сертификаты для вашего доменного имени (в контексте Cloud Load Balancing).**
    
7. **Реализуйте функцию автоматического масштабирования для вашего приложения, используя Google Compute Engine Managed Instance Groups и Cloud Load Balancing.**
    
8. **Изучите возможности использования Cloud DNS для настройки доменных имен и DNS-записей для виртуальных машин на Google Compute Engine и настройте DNS-записи для вашей виртуальной машины.**
    

---

### Опционально:

Напишите скрипт на Python с использованием библиотек Google Cloud Client Libraries для автоматизации развертывания приложения в облаке GCP с использованием механизмов масштабирования и балансировки нагрузки.

---

### Шаги:

1. **Установите `gcloud CLI` на свой компьютер**, если вы еще этого не сделали.
    
2. **Определите параметры вашего Load Balancer**, такие как тип (HTTP(S), TCP/SSL, Internal, External), протоколы, порты и регион/зону.

3. **Создайте шаблон экземпляра (Instance Template)**, определяющий конфигурацию ваших виртуальных машин (например, образ ОС, тип машины).

```bash
gcloud compute instance-templates create web-server-template \
    --machine-type=e2-micro \
    --image-family=debian-11 \
    --image-project=debian-cloud \
    --metadata-from-file=startup-script=startup-script.sh \
    --tags=http-server \
    --region=$REGION \
    --description="Шаблон экземпляра для веб-серверов с Nginx"
```

![](screenshots/Pasted%20image%2020250726160308.png)

5. Создайте правило брандмауэра для HTTP-трафика. Это правило разрешает входящий HTTP-трафик (порт 80) на экземпляры с тегом 'http-server'.

```bash
gcloud compute firewall-rules create default-allow-http \
    --network=default \
    --action=ALLOW \
    --direction=INGRESS \
    --rules=tcp:80 \
    --source-ranges=0.0.0.0/0 \
    --target-tags=http-server \
    --description="Разрешить входящий HTTP-трафик на экземпляры с тегом http-server"
```

![](screenshots/Pasted%20image%2020250726170149.png)

6. **Создайте управляемую группу экземпляров (Managed Instance Group)**, использующую ваш шаблон экземпляра и включающую ваши экземпляры Google Compute Engine.

```bash
gcloud compute instance-groups managed create web-server-mig \
    --base-instance-name=web-server \
    --size=2 \
    --template=web-server-template \
    --zone=$ZONE \
    --description="Управляемая группа экземпляров для веб-серверов"
```

```bash
gcloud compute instance-groups managed set-named-ports web-server-mig \
    --named-ports=http:80 \
    --zone=$ZONE \
```

![](screenshots/Pasted%20image%2020250726161627.png)

7. Создание health-cheks

```bash
gcloud compute health-checks create http web-server-health-check \
    --request-path=/ \
    --port=80 \
    --check-interval=5s \
    --timeout=5s \
    --unhealthy-threshold=2 \
    --healthy-threshold=1 \
    --description="Проверка работоспособности HTTP для веб-серверов"
```

![](screenshots/Pasted%20image%2020250726161650.png)

8. **Создайте группу бэкендов (Backend Service/Backend Bucket)**, содержащую Managed Instance Group, на которую будет направляться трафик.

```bash
gcloud compute backend-services create web-server-backend-service \
    --protocol=HTTP \
    --port-name=http \
    --health-checks=web-server-health-check \
    --global \
    --description="Служба бэкенда для веб-серверов"
```

```bash
gcloud compute backend-services add-backend web-server-backend-service \
    --instance-group=web-server-mig \
    --instance-group-zone=$ZONE \
    --global \
    --description="Добавление MIG в службу бэкенда"
```

![](screenshots/Pasted%20image%2020250726162413.png)

9. **Настройте автоматическое масштабирование** (Auto Scaling) для вашей Managed Instance Group, определив правила масштабирования (на основе CPU, HTTP-запросов и т.д.).

![](screenshots/Pasted%20image%2020250726162644.png)

10. Создайте карту URL-адресов .Карта URL-адресов направляет запросы к службе бэкенда.

```bash
gcloud compute url-maps create web-server-url-map \
    --default-service=web-server-backend-service \
    --description="Карта URL-адресов для веб-серверов"
```

![](screenshots/Pasted%20image%2020250726163207.png)

11. Создайте целевой HTTP-прокси. Целевой прокси принимает запросы и использует карту URL-адресов

```bash
gcloud compute target-http-proxies create web-server-http-proxy \
    --url-map=web-server-url-map \
    --description="Целевой HTTP-прокси для веб-серверов"
```

![](screenshots/Pasted%20image%2020250726163936.png)

12. Создайте глобальное правило пересылки. Это правило предоставляет внешний IP-адрес для вашего балансировщика нагрузки.

```bash
gcloud compute forwarding-rules create web-server-http-forwarding-rule \
    --address=$(gcloud compute addresses create web-server-lb-ip --ip-version=IPV4 --global --description="IP-адрес для балансировщика нагрузки" --format="value(address)") \
    --global \
    --target-http-proxy=web-server-http-proxy \
    --ports=80 \
    --description="Глобальное правило пересылки для HTTP-балансировщика нагрузки"
```

![](screenshots/Pasted%20image%2020250726164019.png)

```
export PROJECT_ID="prod-467112" # Замените на ID вашего проекта GCP
export DOMAIN_NAME="svdbel.org" # Используем ваш домен svdbel.org
export MANAGED_ZONE_NAME="svd-app-zone"
export LOAD_BALANCER_IP=$(gcloud compute forwarding-rules describe web-server-http-forwarding-rule --global --format='value(IPAddress)')
```


13. **Зарегистрируйте доменное имя для вашего приложения в Cloud DNS** (или используйте уже существующий домен и создайте управляемую зону).

```bash
gcloud dns managed-zones create $MANAGED_ZONE_NAME \
    --dns-name="$DOMAIN_NAME." \
    --description="Управляемая зона для моего веб-приложения" \
    --visibility="public"
```

![](screenshots/Pasted%20image%2020250727005519.png)

``Получите DNS-серверы, назначенные вашей управляемой зоне.Эти серверы вам нужно будет настроить у вашего регистратора доменов.DNS-серверы для вашей зоны (их нужно будет настроить у вашего регистратора доменов):

```bash
gcloud dns managed-zones describe $MANAGED_ZONE_NAME --format="value(nameServers)"
```

![](screenshots/Pasted%20image%2020250727001112.png)

13. **Создайте записи DNS** для вашего доменного имени, указывающие на IP-адрес вашего Cloud Load Balancer или, при необходимости, на экземпляры Google Compute Engine.

`Эта запись связывает ваше доменное имя (например, your-domain.com) с IP-адресом балансировщика нагрузки.`

```bash
gcloud dns record-sets create "$DOMAIN_NAME." \
    --rrdatas="$LOAD_BALANCER_IP" \
    --type="A" \
    --ttl="300" \
    --zone="$MANAGED_ZONE_NAME"
```

![](screenshots/Pasted%20image%2020250727010108.png)

14. **Настройте маршрутизацию трафика в Cloud DNS**, используя различные типы записей и политики маршрутизации, такие как взвешенная маршрутизация (Weighted Round Robin) и гео-маршрутизация (Geo-location routing).

`Используется один балансировщик нагрузки`

15. **Используйте команды `gcloud dns record-sets create`, `update`, `delete`** для создания, изменения и удаления записей DNS и маршрутизации трафика в Cloud DNS.

 `Обновление существующей A-записи`:
 
```bash
gcloud dns record-sets update "$DOMAIN_NAME." \
		--rrdatas="NEW_LOAD_BALANCER_IP" \
		--type="A" \
		--ttl="300" \
		--zone="$MANAGED_ZONE_NAME"
```

`Удаление записи:`

```bash
gcloud dns record-sets delete "$DOMAIN_NAME." \
		--type="CNAME" \
		 --zone="$MANAGED_ZONE_NAME"
```


16. **Используйте команды `gcloud` для автоматизации настройки маршрутизации трафика в Cloud DNS на основе метрик мониторинга** (например, используя Cloud Monitoring и Cloud Functions для реагирования на изменения загрузки экземпляров Google Compute Engine и доступности вашего приложения).