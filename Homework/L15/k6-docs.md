# Краткое руководство по использованию k6 для нагрузочного тестирования

k6 — это современный инструмент для нагрузочного тестирования с открытым исходным кодом, ориентированный на разработчиков. Он использует JavaScript для написания сценариев тестов, что делает его удобным и гибким.

## Установка

```bash
wget https://github.com/grafana/k6/releases/download/v0.58.0/k6-v0.58.0-linux-amd64.deb

sudo dpkg -i k6-v0.58.0-linux-amd64.deb
```
(Для полной инструкции см. [официальную документацию k6](https://k6.io/docs/get-started/installation/)).

## Основные концепции

* **Тест-скрипт (`.js`)**: Сценарий теста пишется на JavaScript. Основные части:
    * `import`: Импорт необходимых модулей k6 (`k6/http`, `k6`, и т.д.).
    * `export const options = {...}`: Настройки выполнения теста (количество пользователей, длительность, этапы нагрузки, пороги).
    * `export default function() {...}`: Основная функция, код которой выполняется виртуальными пользователями (VUs) в цикле.
* **Виртуальные пользователи (VUs)**: Имитируют реальных пользователей, одновременно выполняющих код `default` функции.
* **Настройки (`options`)**: Определяют, как будет проходить тест:
    * `vus`: Фиксированное количество VUs.
    * `duration`: Фиксированная длительность теста.
    * `stages`: Массив этапов для определения профиля нагрузки (плавный рост, полка, плавное снижение VUs).
    * `thresholds`: Критерии для автоматического определения успеха или провала теста (например, по времени ответа или проценту ошибок).
* **Метрики**: k6 собирает множество метрик во время теста: время ответа (`http_req_duration`), количество запросов в секунду (`http_reqs`), количество ошибок (`http_req_failed`), результаты проверок (`checks`) и другие.

## Пример сценария теста

Вот пример скрипта (`nginx_test.js`), который мы обсуждали, с **исправленным последним этапом** для корректного снижения нагрузки:

```javascript
// Импортируем модуль k6 для выполнения HTTP-запросов
import http from 'k6/http';
// Импортируем функции check (для проверок) и sleep (для пауз) из k6
import { check, sleep } from 'k6';

// Экспортируем константу 'options', которая содержит настройки выполнения теста
export const options = {
  // Определяем этапы (стадии) теста для управления нагрузкой
  stages: [
    // Этап 1: Плавно увеличиваем количество VUs с 0 до 100 за 10 секунд.
    { duration: '10s', target: 100 },
    // Этап 2: Поддерживаем нагрузку на уровне 100 VUs в течение 20 секунд.
    { duration: '20s', target: 100 },
    // Этап 3: Плавно снижаем количество VUs со 100 до 0 за 5 секунд (Ramp-down).
    { duration: '5s', target: 0 },
  ],
  // Определяем пороговые значения (thresholds) для оценки успешности теста
  thresholds: {
    // Доля (rate) неуспешных HTTP запросов должна быть меньше 1% (0.01)
    http_req_failed: ['rate<0.01'],
    // 95-й перцентиль времени выполнения HTTP запроса должен быть меньше 500 миллисекунд
    http_req_duration: ['p(95)<500'],
  },
};

// Экспортируем функцию 'default', которая будет выполняться каждым виртуальным
// пользователем (VU) в цикле на протяжении всего теста.
export default function () {
  // Выполняем HTTP GET запрос к указанному URL
  // (Включая параметр для отслеживания в логах)
  // Результат запроса (ответ сервера) сохраняем в переменную 'res'
  const res = http.get('http://192.168.100.171:80/?test_run=k6_script_test');

  // Выполняем проверку (check) полученного ответа 'res'
  check(res, {
    // Имя проверки: 'status is 200'
    // Условие проверки: статус ответа (r.status) строго равен 200
    'status is 200': (r) => r.status === 200,
  });

  // Приостанавливаем выполнение для ТЕКУЩЕГО виртуального пользователя на 1 секунду
  // перед тем, как он начнет следующую итерацию (следующий вызов этой функции).
  sleep(1);
}
```
## Запуск
```bash
k6 run nginx_test.js
```

![](screenshots/Pasted%20image%2020250505215013.png)