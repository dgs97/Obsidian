# Домашнее задание №39: Введение в Terraform для Google Cloud Platform (GCP)

---

## Цель задания

Ознакомиться с основами **инфраструктуры как кода (Infrastructure as Code - IaC)** и практическим применением **Terraform** для управления инфраструктурой в **Google Cloud Platform (GCP)**.

---

## Задание

1. **Изучите основы IaC и понятия Terraform.**
2. **Установите Terraform** на своей локальной машине.
3. **Создайте новый проект** в Terraform и настройте его конфигурацию.
4. **Настройте аутентификацию для GCP** (например, через `gcloud` CLI).
5. **Создайте несколько ресурсов GCP** в вашей конфигурации Terraform (например, виртуальные машины, сетевые правила, хранилища).
6. **Определите переменные** для вашей конфигурации и используйте их в ресурсах.
7. Выполните команду `terraform init` для инициализации проекта.
8. Выполните команду `terraform plan` для просмотра плана развертывания.
9. Выполните команду `terraform apply` для применения изменений и развертывания вашей инфраструктуры.
10. **Проверьте**, что ваша инфраструктура успешно развернута и функционирует корректно.
11. **(Дополнительное задание)** Измените конфигурацию Terraform, добавив или изменяя ресурсы, и повторно выполните `terraform plan` и `terraform apply`.

---

## Шаги выполнения

### 1. Изучение основ IaC и Terraform

- Ознакомьтесь с документацией Terraform: [https://www.terraform.io/docs/index.html](https://www.terraform.io/docs/index.html)
- Изучите материалы по концепции "Инфраструктура как код".

### 2. Установка Terraform

- Следуйте инструкциям по установке Terraform на официальном сайте: [https://www.terraform.io/downloads.html](https://www.terraform.io/downloads.html)
 `Выбрано : прямая загрузка бинарного файла` 
 
```bash
wget 
https://releases.hashicorp.com/terraform/1.12.2/terraform_1.12.2_linux_amd64.zip
```

```bash
unzip terraform_1.12.2_linux_amd64
```

![](screenshots/Pasted%20image%2020250730134540.png)

```bash
sudo mv terraform /usr/local/bin/
```

```bash
terraform --version
```

### 3. Настройка аутентификации GCP

Прежде чем начать работу с Terraform для GCP, вам необходимо настроить аутентификацию. Самый простой способ – использовать `gcloud CLI` и войти в свою учетную запись:

- **Установите `gcloud CLI`**: Следуйте инструкциям на официальном сайте Google Cloud.
- **Авторизуйтесь**: В терминале выполните:

```bash
gcloud auth application-default login
```

Это создаст учетные данные, которые Terraform сможет использовать.

- **Установите проект по умолчанию**:
 
```bash
gcloud config set project YOUR_GCP_PROJECT_ID
```

### 4. Создание проекта Terraform

- Создайте новую директорию для вашего проекта Terraform. Например:
  
```bash
mkdir my-gcp-terraform-project
cd my-gcp-terraform-project
```

### 5. Создание файла конфигурации `main.tf`

- Внутри директории проекта создайте файл конфигурации Terraform с именем `main.tf` (или любым другим удобным именем) и откройте его в текстовом редакторе.

### 6. Определение провайдера GCP

- В файле `main.tf` определите провайдера `google` и настройте его параметры. **Важно**: Terraform автоматически использует учетные данные, настроенные через `gcloud auth application-default login`, поэтому явные учетные данные в файле `main.tf` обычно не требуются для большинства сценариев.

    ```terraform
    # Укажите необходимую версию провайдера Google
    terraform {
      required_providers {
        google = {
          source  = "hashicorp/google"
          version = "~> 6.45.0" # Используйте актуальную версию
        }
      }
    }
    
    provider "google" {
      project = var.gcp_project_id # Будет определено в variables.tf
      region  = var.gcp_region      # Будет определено в variables.tf
    }
    ```

### 7. Определение ресурсов GCP

- Определите несколько ресурсов, которые вы хотите развернуть. Например, вы можете создать **виртуальную машину Google Compute Engine (GCE)** и **Google Cloud Storage (GCS) Bucket** в файле `main.tf`:
  
    ```terraform
    # Пример создания виртуальной машины GCE
    resource "google_compute_instance" "example_vm" {
      name         = "my-terraform-instance"
      machine_type = var.instance_type # Используем переменную
      zone         = "${var.gcp_region}-a" # Пример зоны в регионе
    
      boot_disk {
        initialize_params {
          image = "debian-cloud/debian-11" # Пример образа
        }
      }
    
      network_interface {
        network = "default" # Используем сеть по умолчанию
      }
    
      metadata_startup_script = "echo 'Hello from Terraform on GCP!' | tee /var/log/startup.log"
    }
    
    # Пример создания Cloud Storage Bucket
    resource "google_storage_bucket" "example_bucket" {
      name          = "my-terraform-bucket-${random_id.bucket_suffix.hex}" # Уникальное имя
      location      = var.gcp_region
      storage_class = "STANDARD"
      force_destroy = true # Удалит содержимое при удалении бакета Terraform
    }
    
    # Для создания уникального имени бакета
    resource "random_id" "bucket_suffix" {
      byte_length = 4
    }
    ```

### 8. Определение и использование переменных

- Создайте файл `variables.tf` в директории проекта и определите переменные:
  
    ```terraform
    variable "gcp_project_id" {
      description = "The ID of the GCP project."
      type        = string
      # default     = "your-gcp-project-id" # Можно указать здесь или применить через gcloud config set project
    }
    
    variable "gcp_region" {
      description = "The GCP region to deploy resources in."
      type        = string
      default     = "europe-central2" # Пример региона, выберите ближайший
    }
    
    variable "instance_type" {
      description = "The machine type for the GCE instance."
      type        = string
      default     = "e2-micro"
    }
    ```

    _Совет: Вместо жесткого задания `gcp_project_id` в `variables.tf`, Terraform может автоматически получить его, если вы установили его через `gcloud config set project` и не переопределяете его в провайдере._

### 9. Инициализация проекта Terraform

- Откройте командную строку или терминал, перейдите в директорию проекта Terraform и выполните:
  
```bash
terraform init
```

    Эта команда загрузит необходимый провайдер Google.

![](screenshots/Pasted%20image%2020250730151733.png)

### 10. Просмотр плана развертывания

- Чтобы увидеть, какие изменения Terraform планирует применить, выполните:
 
```bash
terraform plan -var="gcp_project_id=YOUR_GCP_PROJECT_ID"
```

### 11. Применение изменений

- Если план развертывания выглядит правильно, выполните команду для применения изменений и развертывания вашей инфраструктуры:
   
```bash
terraform apply -var="gcp_project_id=YOUR_GCP_PROJECT_ID"
```
  
    Вам будет предложено подтвердить выполнение команды, введя yes.

![](screenshots/Pasted%20image%2020250730153103.png)

### 12. Проверка развернутой инфраструктуры

- После успешного выполнения `terraform apply` проверьте, что ваша инфраструктура была успешно развернута и функционирует корректно. Например, войдите в консоль GCP (Compute Engine, Cloud Storage) и убедитесь, что виртуальная машина и бакет созданы.

![](screenshots/Pasted%20image%2020250730153149.png)

![](screenshots/Pasted%20image%2020250730153212.png)

### 13. (Дополнительное задание) Изменение и обновление инфраструктуры

- Измените конфигурацию Terraform, добавив или изменяя ресурсы (например, измените тип инстанса GCE, добавьте правила фаервола, создайте базу данных Cloud SQL).

- Сохраните изменения в файлах `.tf`.

- Повторно выполните команды:
 
```bash
terraform plan -var="gcp_project_id=YOUR_GCP_PROJECT_ID"
terraform apply -var="gcp_project_id=YOUR_GCP_PROJECT_ID"
```

    Это позволит применить обновленные изменения к вашей инфраструктуре.

Изменил VM (c "e2-micro" на"e2-small") и добавил фаервол:

![](screenshots/Pasted%20image%2020250730163601.png)

После выполнения команды `terraform apply` возникла ошибка (так как Terraform требует явного разрешения на остановку, чтобы избежать случайного прерывания работы) :

![](screenshots/Снимок%20экрана%20от%202025-07-30%2016-39-22.png)

Для корректной работы добавляем строчку в `main.tf`:

```bash
allow_stopping_for_update = true  # ✅ Разрешить остановку
```


![](screenshots/Pasted%20image%2020250730164717.png)

Итог:

- Изменили тип VM

![](screenshots/Pasted%20image%2020250730165705.png)

- Добавили правило Firewall:

![](screenshots/Pasted%20image%2020250730170122.png)